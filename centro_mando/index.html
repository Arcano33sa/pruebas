<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0b" />
  <meta http-equiv="refresh" content="6;url=../centro-mando/index.html" />
  <title>Centro de Mando — Actualizando…</title>
  <link rel="stylesheet" href="/assets/css/a33-header.css?v=4.20.7" />
  <style>
    body{margin:0;background:#0b0b0b;color:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:min(560px,100%);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:18px;margin:0 0 8px}
    p{margin:0 0 10px;line-height:1.35;color:#cfcfcf;font-size:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#caa85c}
    .small{font-size:12px;color:#b8b8b8}
  </style>
</head>
<body>
  <div class="wrap"><div class="card">
    <h1>Centro de Mando se movió</h1>
    <p>Actualizando… Si tenías una PWA vieja, esto intenta limpiar el caché y llevarte al Centro de Mando correcto.</p>
    <p class="mono" id="status">Preparando…</p>
    <p class="small" id="detail"></p>
    <p class="small">v4.20.7</p>
  </div></div>
  <script>
    (async ()=>{
      const target = "../centro-mando/index.html";
      const status = document.getElementById("status");
      const detail = document.getElementById("detail");
      const set = (el, t)=>{ if(el) el.textContent = t; };
      set(status, "Actualizando…");
      try {
        if ("serviceWorker" in navigator) {
          try {
            await navigator.serviceWorker.register('./sw.js?v=4.20.7');
          } catch (e) {}
        }

        if ("serviceWorker" in navigator && navigator.serviceWorker.getRegistrations) {
          set(detail, "Desregistrando Service Workers antiguos…");
          const regs = await navigator.serviceWorker.getRegistrations();
          const kills = regs.filter(r => {
            const scope = String(r.scope||"").toLowerCase();
            const sw = (r.active || r.waiting || r.installing);
            const script = String((sw && sw.scriptURL) || "").toLowerCase();
            return scope.includes("centro") && !script.includes("sw.js?v=4.20.7");
          });
          await Promise.all(kills.map(r => r.unregister().catch(()=>false)));
        }
      } catch (e) {}
      try {
        if (window.caches && caches.keys) {
          set(detail, "Limpiando cachés…");
          const keys = await caches.keys();
          const kill = keys.filter(k => {
            const s = String(k||"").toLowerCase();
            return s.includes("a33-centro") || s.includes("centro_mando") || s.includes("centro-mando");
          });
          await Promise.all(kill.map(k => caches.delete(k).catch(()=>false)));
        }
      } catch (e) {}
      set(status, "Redirigiendo…");
      try { location.replace(target); } catch(e) { location.href = target; }
      setTimeout(()=>{
        if (location.pathname.toLowerCase().includes("centro_mando")) location.href = target;
      }, 900);
    })();
  </script>
</body>
</html>
