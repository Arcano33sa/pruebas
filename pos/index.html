<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A33 POS · Eventos</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="title">A33 POS · Eventos</div>
        <div class="subtitle muted">Suite A33 · Offline (IndexedDB)</div>
      </div>
    </div>
    <div class="top-actions">
      <button id="btn-export" class="btn-primary" type="button">Exportar Excel</button>
      <button id="btn-reset" class="btn-warn" type="button">Reset (solo pruebas)</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tabbtn active" data-tab="tab-vender">Vender</button>
    <button class="tabbtn" data-tab="tab-inventario">Inventario</button>
    <button class="tabbtn" data-tab="tab-eventos">Eventos</button>
    <button class="tabbtn" data-tab="tab-caja">Caja Chica</button>
    <button class="tabbtn" data-tab="tab-resumen">Resumen</button>
  </nav>

  <main class="container">
    <!-- VENDER -->
    <section id="tab-vender" class="tab card">
      <h2>Vender</h2>

      <div class="row">
        <div class="col">
          <label>Evento activo</label>
          <select id="sale-event"></select>
          <small class="muted">Selecciona un evento activo para registrar ventas.</small>
        </div>
        <div class="col">
          <label>Fecha</label>
          <input id="sale-date" type="date" />
        </div>
        <div class="col">
          <label>Hora</label>
          <input id="sale-time" type="time" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Producto</label>
          <select id="sale-product"></select>
        </div>
        <div class="col">
          <label>Cantidad</label>
          <input id="sale-qty" type="number" step="1" min="1" value="1" />
        </div>
        <div class="col">
          <label>Precio unitario (C$)</label>
          <input id="sale-price" type="number" step="0.01" min="0" />
        </div>
        <div class="col">
          <label>Descuento (C$)</label>
          <input id="sale-discount" type="number" step="0.01" min="0" value="0" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Pago</label>
          <select id="sale-payment">
            <option value="efectivo">Efectivo</option>
            <option value="transferencia">Transferencia</option>
            <option value="credito">Crédito</option>
          </select>
        </div>
        <div class="col">
          <label>Banco (si transferencia)</label>
          <select id="sale-bank"></select>
        </div>
        <div class="col">
          <label>Cliente</label>
          <input id="sale-customer" type="text" placeholder="Opcional" />
        </div>
        <div class="col">
          <label>Notas</label>
          <input id="sale-notes" type="text" placeholder="Opcional" />
        </div>
      </div>

      <div class="row">
        <label class="chk">
          <input id="sale-courtesy" type="checkbox" />
          Cortesía
        </label>

        <div id="courtesy-to-wrap" class="col" style="display:none; min-width:260px">
          <label>Cortesía a</label>
          <input id="sale-courtesy-to" type="text" placeholder="Nombre / referencia" />
        </div>

        <div class="spacer"></div>
        <button id="btn-add-sale" class="btn-ok" type="button">Registrar venta</button>
      </div>

      <div class="divider"></div>

      <h3>Listado del día</h3>
      <div class="row">
        <div class="col">
          <label>Filtrar por día</label>
          <input id="day-filter" type="date" />
        </div>
        <div class="spacer"></div>
        <button id="btn-clear-filter" class="btn-link" type="button">Quitar filtro</button>
      </div>

      <table class="tbl" id="tbl-day">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Producto</th>
            <th>Cant</th>
            <th>Total</th>
            <th>Pago</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- INVENTARIO -->
    <section id="tab-inventario" class="tab card" style="display:none">
      <h2>Inventario (evento)</h2>

      <div class="row">
        <div class="col">
          <label>Evento</label>
          <select id="inv-event"></select>
        </div>
        <div class="spacer"></div>
        <button id="btn-add-from-lote" class="btn-primary" type="button">Agregar desde lote</button>
      </div>

      <!-- bloque lotes cargados -->
      <div class="lotes-block">
        <div class="lotes-block-head">
          <div>
            <div style="font-weight:900">Lotes cargados en este evento <span class="badge" id="lotes-count">0</span></div>
            <div class="muted" style="margin-top:2px">Resumen por lote (una sola línea por lote).</div>
          </div>
          <div class="muted" id="lotes-hint"></div>
        </div>

        <table class="tbl" id="tbl-lotes-evento" style="margin-top:10px">
          <thead>
            <tr>
              <th>Lote</th>
              <th>Agregado</th>
              <th>P</th>
              <th>M</th>
              <th>D</th>
              <th>L</th>
              <th>G</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="divider"></div>

      <h3>Stock disponible</h3>
      <table class="tbl" id="tbl-inv">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Disponible</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- EVENTOS -->
    <section id="tab-eventos" class="tab card" style="display:none">
      <h2>Eventos</h2>

      <div class="row">
        <div class="col">
          <label>Evento Maestro (grupo)</label>
          <select id="grupo-select"></select>
          <small class="muted">Se mantiene por defecto el último grupo trabajado.</small>
        </div>

        <div class="col">
          <label>Nombre del evento</label>
          <input id="event-name" type="text" placeholder="Ej: Feria X - Día 1" />
        </div>

        <div class="spacer"></div>

        <button id="btn-create-event" class="btn-ok" type="button">Crear evento</button>
      </div>

      <div class="divider"></div>

      <h3>Eventos existentes</h3>
      <table class="tbl" id="tbl-events">
        <thead>
          <tr>
            <th>Evento</th>
            <th>Estado</th>
            <th>Creado</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- CAJA CHICA -->
    <section id="tab-caja" class="tab card" style="display:none">
      <h2>Caja Chica</h2>

      <div id="pc-no-event-note" class="warn" style="display:none">
        Activa un evento antes de usar Caja Chica.
      </div>

      <div id="pc-main" style="display:none">
        <div class="row">
          <div class="col">
            <label>Evento</label>
            <div id="pc-event-info" class="info"></div>
          </div>
          <div class="col">
            <label>Día</label>
            <input id="pc-day" type="date" />
            <small class="muted">El día controla el registro de Caja Chica por fecha dentro del mismo evento.</small>
          </div>
        </div>

        <div class="card petty-history">
          <h3>Histórico de cierres</h3>
          <div class="row" style="gap:10px">
            <div class="col" style="min-width:280px">
              <label>Ver día cerrado</label>
              <select id="pc-history-select"></select>
              <small id="pc-history-hint" class="muted"></small>
            </div>
            <div class="col">
              <label>&nbsp;</label>
              <div class="row" style="gap:8px">
                <button id="pc-history-back" class="btn-link" type="button" style="display:none">Volver al día operativo</button>
                <button id="pc-history-use" class="btn-primary" type="button" style="display:none">Usar este cierre como inicio</button>
              </div>
            </div>
          </div>
          <div id="pc-history-banner" class="info" style="display:none; margin-top:8px"></div>
          <div id="pc-history-note" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="card petty-initial">
          <h3>Saldo inicial</h3>
          <div class="row" style="gap:10px; align-items:flex-end">
            <div class="col">
              <button id="pc-btn-use-prev" class="btn-primary" type="button">Usar cierre anterior</button>
              <small id="pc-prev-note" class="muted"></small>
            </div>
          </div>

          <div class="row">
            <div class="petty-block">
              <h4>Córdobas (C$)</h4>
              <table class="pc-table" id="pc-table-nio">
                <thead>
                  <tr><th>Denominación</th><th>Cantidad</th><th>Subtotal</th></tr>
                </thead>
                <tbody>
                  <tr><td>C$ 1</td><td><input id="pc-nio-q-1" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-1">0.00</span></td></tr>
                  <tr><td>C$ 5</td><td><input id="pc-nio-q-5" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-5">0.00</span></td></tr>
                  <tr><td>C$ 10</td><td><input id="pc-nio-q-10" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-10">0.00</span></td></tr>
                  <tr><td>C$ 20</td><td><input id="pc-nio-q-20" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-20">0.00</span></td></tr>
                  <tr><td>C$ 50</td><td><input id="pc-nio-q-50" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-50">0.00</span></td></tr>
                  <tr><td>C$ 100</td><td><input id="pc-nio-q-100" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-100">0.00</span></td></tr>
                  <tr><td>C$ 200</td><td><input id="pc-nio-q-200" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-200">0.00</span></td></tr>
                  <tr><td>C$ 500</td><td><input id="pc-nio-q-500" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-500">0.00</span></td></tr>
                  <tr><td>C$ 1000</td><td><input id="pc-nio-q-1000" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-nio-sub-1000">0.00</span></td></tr>
                </tbody>
                <tfoot>
                  <tr><td colspan="2">Total inicial C$</td><td>C$ <span id="pc-nio-total">0.00</span></td></tr>
                </tfoot>
              </table>
            </div>

            <div class="petty-block">
              <h4>Dólares (US$)</h4>
              <table class="pc-table" id="pc-table-usd">
                <thead>
                  <tr><th>Denominación</th><th>Cantidad</th><th>Subtotal</th></tr>
                </thead>
                <tbody>
                  <tr><td>US$ 1</td><td><input id="pc-usd-q-1" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-usd-sub-1">0.00</span></td></tr>
                  <tr><td>US$ 5</td><td><input id="pc-usd-q-5" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-usd-sub-5">0.00</span></td></tr>
                  <tr><td>US$ 10</td><td><input id="pc-usd-q-10" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-usd-sub-10">0.00</span></td></tr>
                  <tr><td>US$ 20</td><td><input id="pc-usd-q-20" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-usd-sub-20">0.00</span></td></tr>
                  <tr><td>US$ 50</td><td><input id="pc-usd-q-50" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-usd-sub-50">0.00</span></td></tr>
                  <tr><td>US$ 100</td><td><input id="pc-usd-q-100" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-usd-sub-100">0.00</span></td></tr>
                </tbody>
                <tfoot>
                  <tr><td colspan="2">Total inicial US$</td><td>US$ <span id="pc-usd-total">0.00</span></td></tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="row">
            <button id="pc-btn-save-initial" class="btn-ok">Guardar saldo inicial</button>
            <button id="pc-btn-clear-initial" class="btn-warn">Limpiar</button>
          </div>
        </div>

        <div class="card petty-mov">
          <h3>Movimientos</h3>

          <div class="row">
            <div class="col">
              <label>Tipo</label>
              <select id="pc-mov-type">
                <option value="entrada">Entrada</option>
                <option value="salida">Salida</option>
              </select>
            </div>
            <div class="col">
              <label>Moneda</label>
              <select id="pc-mov-currency">
                <option value="NIO">C$</option>
                <option value="USD">US$</option>
              </select>
            </div>
            <div class="col">
              <label>Monto</label>
              <input id="pc-mov-amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div class="col">
              <label>Descripción</label>
              <input id="pc-mov-desc" type="text" placeholder="Ej: Compra hielo, cambio, etc." />
            </div>
            <div class="col" style="min-width:160px">
              <label>&nbsp;</label>
              <button id="pc-mov-add" class="btn-primary" type="button">Agregar</button>
            </div>
          </div>

          <table class="pc-table" id="pc-mov-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Moneda</th>
                <th>Monto</th>
                <th>Descripción</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="pc-mov-tbody">
            </tbody>
          </table>
        </div>

        <div class="card petty-final">
          <h3>Arqueo final</h3>
          <div class="row">
            <div class="petty-block">
              <h4>Córdobas (C$)</h4>
              <table class="pc-table" id="pc-table-fnio">
                <thead>
                  <tr><th>Denominación</th><th>Cantidad</th><th>Subtotal</th></tr>
                </thead>
                <tbody>
                  <tr><td>C$ 1</td><td><input id="pc-fnio-q-1" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-1">0.00</span></td></tr>
                  <tr><td>C$ 5</td><td><input id="pc-fnio-q-5" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-5">0.00</span></td></tr>
                  <tr><td>C$ 10</td><td><input id="pc-fnio-q-10" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-10">0.00</span></td></tr>
                  <tr><td>C$ 20</td><td><input id="pc-fnio-q-20" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-20">0.00</span></td></tr>
                  <tr><td>C$ 50</td><td><input id="pc-fnio-q-50" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-50">0.00</span></td></tr>
                  <tr><td>C$ 100</td><td><input id="pc-fnio-q-100" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-100">0.00</span></td></tr>
                  <tr><td>C$ 200</td><td><input id="pc-fnio-q-200" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-200">0.00</span></td></tr>
                  <tr><td>C$ 500</td><td><input id="pc-fnio-q-500" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-500">0.00</span></td></tr>
                  <tr><td>C$ 1000</td><td><input id="pc-fnio-q-1000" type="number" min="0" step="1" value="0"></td><td>C$ <span id="pc-fnio-sub-1000">0.00</span></td></tr>
                </tbody>
                <tfoot>
                  <tr><td colspan="2">Total final C$</td><td>C$ <span id="pc-fnio-total">0.00</span></td></tr>
                </tfoot>
              </table>
            </div>

            <div class="petty-block">
              <h4>Dólares (US$)</h4>
              <table class="pc-table" id="pc-table-fusd">
                <thead>
                  <tr><th>Denominación</th><th>Cantidad</th><th>Subtotal</th></tr>
                </thead>
                <tbody>
                  <tr><td>US$ 1</td><td><input id="pc-fusd-q-1" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-fusd-sub-1">0.00</span></td></tr>
                  <tr><td>US$ 5</td><td><input id="pc-fusd-q-5" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-fusd-sub-5">0.00</span></td></tr>
                  <tr><td>US$ 10</td><td><input id="pc-fusd-q-10" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-fusd-sub-10">0.00</span></td></tr>
                  <tr><td>US$ 20</td><td><input id="pc-fusd-q-20" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-fusd-sub-20">0.00</span></td></tr>
                  <tr><td>US$ 50</td><td><input id="pc-fusd-q-50" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-fusd-sub-50">0.00</span></td></tr>
                  <tr><td>US$ 100</td><td><input id="pc-fusd-q-100" type="number" min="0" step="1" value="0"></td><td>US$ <span id="pc-fusd-sub-100">0.00</span></td></tr>
                </tbody>
                <tfoot>
                  <tr><td colspan="2">Total final US$</td><td>US$ <span id="pc-fusd-total">0.00</span></td></tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="row">
            <button id="pc-btn-save-final" class="btn-ok">Guardar arqueo final</button>
            <button id="pc-btn-clear-final" class="btn-warn">Limpiar</button>
          </div>
        </div>

        <div class="card petty-cierre">
          <h3>Cierre definitivo del día</h3>

          <div class="row">
            <div class="col">
              <label><b>T/C:</b></label>
              <input id="pc-fx-rate" type="number" inputmode="decimal" step="0.01" min="0" placeholder="T/C: (C$ por 1 US$)">
              <small class="muted">C$ por 1 US$. Se requiere solo si hubo USD en Caja Chica hoy.</small>
            </div>
            <div class="col" style="min-width:160px">
              <label>&nbsp;</label>
              <button id="pc-btn-save-fx" class="btn-primary" type="button">Guardar T/C</button>
            </div>
          </div>

          <div id="pc-close-status" class="info" style="margin-top:8px"></div>
          <div id="pc-close-blocker" class="warn" style="display:none; margin-top:8px"></div>

          <div class="row" style="margin-top:10px">
            <div class="petty-block">
              <h4>Ajuste de arqueo C$</h4>
              <div class="pc-adj-grid">
                <input id="pc-adj-nio-amount" type="number" inputmode="decimal" step="0.01" placeholder="Monto del ajuste (obligatorio)">
                <input id="pc-adj-nio-concept" type="text" placeholder="Concepto (obligatorio)">
                <input id="pc-adj-nio-notes" type="text" placeholder="Notas (opcional)">
              </div>
              <div class="row" style="gap:8px">
                <button id="pc-btn-adj-nio" class="btn-ok" type="button">Registrar ajuste C$</button>
                <button id="pc-btn-clear-adj-nio" class="btn-link" type="button">Quitar ajuste</button>
              </div>
              <div id="pc-adj-nio-status" class="muted"></div>
            </div>

            <div class="petty-block">
              <h4>Ajuste de arqueo US$</h4>
              <div class="pc-adj-grid">
                <input id="pc-adj-usd-amount" type="number" inputmode="decimal" step="0.01" placeholder="Monto del ajuste (obligatorio)">
                <input id="pc-adj-usd-concept" type="text" placeholder="Concepto (obligatorio)">
                <input id="pc-adj-usd-notes" type="text" placeholder="Notas (opcional)">
              </div>
              <div class="row" style="gap:8px">
                <button id="pc-btn-adj-usd" class="btn-ok" type="button">Registrar ajuste US$</button>
                <button id="pc-btn-clear-adj-usd" class="btn-link" type="button">Quitar ajuste</button>
              </div>
              <div id="pc-adj-usd-status" class="muted"></div>
            </div>
          </div>

          <div id="pc-adj-records" class="pc-adj-records" style="display:none"></div>

          <div class="row" style="margin-top:10px">
            <button id="pc-btn-close-day" class="btn-ok" type="button">Cierre definitivo del día</button>
            <button id="pc-btn-reopen-day" class="btn-warn" type="button" style="display:none">Reabrir día</button>
          </div>

          <small class="muted">Regla: si existe diferencia entre el efectivo contado y el esperado, debes registrar movimientos faltantes o un ajuste de arqueo antes de poder cerrar.</small>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <section id="tab-resumen" class="tab card" style="display:none">
      <h2>Resumen</h2>
      <div class="card">
        <strong>Total general: C$ <span id="grand-total">0</span></strong>
      </div>
      <div class="row">
        <div class="card">
          <h3>Por evento</h3>
          <table id="tbl-por-evento">
            <thead><tr><th>Evento</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Por día</h3>
          <table id="tbl-por-dia">
            <thead><tr><th>Fecha</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="row">
        <div class="card">
          <h3>Por producto</h3>
          <table id="tbl-por-prod">
            <thead><tr><th>Producto</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Por método de pago</h3>
          <table id="tbl-por-pago">
            <thead><tr><th>Método</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h3>Transferencias por banco</h3>
          <table id="tbl-transfer-bank">
            <thead><tr><th>Banco</th><th>Total</th><th>#</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script src="app.js"></script>
</body>
</html>
