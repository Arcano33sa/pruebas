<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>A33 POS</title>
<link rel="manifest" href="manifest.webmanifest?v=3.20">
<link rel="apple-touch-icon" href="logo.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f0f"/>
<link rel="stylesheet" href="styles.css?v=3.20">
</head>
<body>
<header class="brandbar">
  <div class="brandwrap">
    <img src="logo.png" alt="Arcano 33" class="brand-left">
  </div>
  <h1 class="app-title">A33 POS <span class="badge">Offline</span></h1>
</header>
<div style="text-align:right; padding: 0.25rem 1rem 0;">
  <button onclick="window.location.href='../index.html'" class="btn-ok" type="button">← Menú principal</button>
</div>
<div id="offlineBar" class="offline">Trabajando sin conexión</div>
<div class="container">

  <section id="tab-venta" class="tab card">
    <h2>Vender</h2>

    <div class="row">
      <div>
        <label>Evento activo</label>
        <div class="row">
          <select id="sale-event">
            <option value="">— Selecciona evento —</option>
          </select>
          <input id="new-event" placeholder="Nuevo evento">
        </div>

<div class="row">
  <label>Evento maestro / Grupo</label>
</div>
<div class="row">
  <select id="event-group-select">
    <option value="">— Selecciona grupo —</option>
    <option value="__new__">+ Crear nuevo grupo</option>
  </select>
  <input id="event-group-new" placeholder="Nombre de nuevo grupo" style="display:none">
</div>
<div class="row">
  <button type="button" id="btn-manage-groups" class="btn-link">Gestionar grupos</button>
</div>
<small class="muted">Usa el mismo nombre de grupo para todos los días del mismo evento maestro. Puedes ocultar grupos antiguos desde “Gestionar grupos”.</small>

        <div class="row">
          <button id="btn-add-event" class="btn-primary">+ Crear y activar evento</button>
          <button id="btn-close-event" class="btn-warn">Cerrar evento (Corte)</button>
          <button id="btn-reopen-event" class="btn-ok">Reabrir evento</button>
        </div>
	        <div class="row" style="grid-template-columns:1fr; align-items:center">
	          <div class="petty-toggle-wrap">
	            <span class="petty-toggle-title">Caja Chica</span>
	            <label class="switch" title="Activar / desactivar Caja Chica para este evento">
	              <input type="checkbox" id="pc-event-toggle">
	              <span class="slider"></span>
	            </label>
	            <span id="pc-event-toggle-text" class="muted"></span>
	          </div>
	        </div>
        <div id="event-status" class="info" style="display:none"></div>
        <div id="no-active-note" class="disabled-note" style="display:none">Sin evento activo. Crea o selecciona uno para comenzar.</div>
      </div>
      <div>
        <label>Fecha</label>
        <input id="sale-date" type="date">
      </div>
    </div>

    <div class="row" id="sell-block">
      <div>
        <label>Producto</label>
        <select id="sale-product"></select>
        <div id="product-chips" class="chips"></div>
      </div>
      <div>
        <label>Precio (C$)</label>
        <input id="sale-price" type="number" inputmode="decimal" step="0.01">
        <div><small class="muted">Stock: <span id="sale-stock">—</span></small></div>
      </div>
    </div>

    <div class="row4">
      <div>
        <label>Cantidad</label>
        <div class="stepper">
          <button id="qty-minus">−</button>
          <input id="sale-qty" type="number" inputmode="numeric" step="1" value="1" min="1">
          <button id="qty-plus">+</button>
        </div>
      </div>
      <div>
        <label>Descuento por unidad (C$)</label>
        <input id="sale-discount" type="number" inputmode="decimal" step="0.01" value="0">
      </div>
      <div>
        <label>Método de pago</label>
        <select id="sale-payment">
          <option value="efectivo" selected>Efectivo</option>
          <option value="transferencia">Transferencia</option>
          <option value="credito">Crédito</option>
        </select>
      </div>
      <div>
        <label>Total (C$)</label>
        <input id="sale-total" type="number" inputmode="decimal" step="0.01" disabled>
      </div>
    </div>

    <div class="row" id="sale-bank-row" style="display:none">
      <div>
        <label>Banco (solo Transferencia)</label>
        <select id="sale-bank">
          <option value="">— Selecciona banco —</option>
        </select>
        <small id="sale-bank-note" class="muted"></small>
      </div>
    </div>

    <details class="card">
      <summary>Más opciones</summary>
      <div class="row">
        <div>
          <label class="flag"><input id="sale-courtesy" type="checkbox"> Cortesía</label>
          <label class="flag"><input id="sale-return" type="checkbox"> Devolución</label>
        </div>
        <div>
          <label>Cliente (si es Crédito)</label>
          <input id="sale-customer" placeholder="Nombre del cliente (crédito)" disabled>
          <label style="margin-top:6px">Cortesía a</label>
          <input id="sale-courtesy-to" placeholder="Nombre (si marcaste cortesía)" disabled>
        </div>
      </div>
      <label>Notas (opcional)</label>
      <textarea id="sale-notes" rows="2" placeholder="ej. promo, ref. de pago, etc."></textarea>
    </details>

    <div class="row">
      <button id="btn-add" class="btn-ok">+ Agregar venta</button>
      <button id="btn-undo" class="btn-warn">↩︎ Deshacer última</button>
    </div>

    <div class="card" id="cup-block">
      <h3>Venta por vaso</h3>

      <div class="row">
        <div><strong>Vasos disponibles: <span id="cup-available">0</span></strong></div>
        <div style="text-align:right"><strong>Galones fraccionados: <span id="cup-gallons">0</span></strong></div>
      </div>

      <div class="row3">
        <div>
          <label>Galones a fraccionar</label>
          <input id="cup-fraction-gallons" type="number" inputmode="numeric" step="1" min="1" value="1">
        </div>
        <div>
          <label>Vasos por galón</label>
          <input id="cup-yield" type="number" inputmode="numeric" step="1" min="1" value="22">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btn-fraction" class="btn-primary">Fraccionar</button>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Cantidad de vasos</label>
          <input id="cup-qty" type="number" inputmode="numeric" step="1" min="1" value="1">
        </div>
        <div>
          <label>Precio por vaso (C$)</label>
          <input id="cup-price" type="number" inputmode="decimal" step="0.01" min="0" value="0">
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="row" style="grid-template-columns:1fr 1fr; gap:8px">
            <button id="btn-sell-cups" class="btn-ok">Vender vasos</button>
            <button id="btn-courtesy-cups" class="btn-warn">Registrar cortesía</button>
          </div>
        </div>
      </div>

      <div class="info" style="margin-top:10px">
        <div><b>Vasos creados:</b> <span id="cup-created">0</span> · <b>Vendidos:</b> <span id="cup-sold">0</span> · <b>Cortesía:</b> <span id="cup-courtesy">0</span> · <b>Restantes:</b> <span id="cup-remaining">0</span></div>
        <div><b>Remanente exacto:</b> <span id="cup-remnant">0</span> ml</div>
      </div>

      <small class="muted">Nota: esto controla porciones vendibles (vasos de sangría). No es inventario de vasos plásticos.</small>
    </div>

    <div class="card">
      <h3>Ventas del día</h3>
      <div class="scroll">
        <table id="sales-table">
          <thead>
            <tr>
              <th>ID</th><th>Hora</th><th>Producto</th><th>Cant</th><th>PU</th><th>Desc</th><th>Total</th><th>Pago</th><th>C</th><th>Dev</th><th>Cliente</th><th>Cortesía a</th><th>Notas</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row">
        <button id="btn-export-day" class="btn-primary">Exportar día (Excel)</button>
        <button id="btn-clear-day" class="btn-danger">Eliminar ventas del día</button>
      </div>
      <small class="muted">Consejo: usa “Deshacer última” si solo te equivocaste en la última venta.</small>
    </div>
  </section>

  <section id="tab-inventario" class="tab card" style="display:none">
    <h2>Inventario</h2>
    <div class="row">
      <div>
        <label>Evento</label>
        <select id="inv-event">
          <option value="">— Selecciona evento —</option>
        </select>
      </div>
      <div>
        <label>Buscar</label>
        <input id="inv-search" placeholder="Buscar producto">
      </div>
    </div>
    <div id="inv-list"></div>

    <div class="card">
      <h3>Lotes cargados en este evento</h3>
      <small class="muted">Aquí se muestra un resumen por lote del inventario que se cargó para este evento.</small>
      <div id="event-lots-summary" class="lots-summary"></div>
    </div>

    <div class="row">
      <button id="btn-load-from-lot" class="btn-primary">Agregar desde lote</button>
      <button id="btn-inv-export" class="btn-primary">Exportar inventario (Excel)</button>
    </div>

    <div id="load-modal" class="modal">
      <div class="panel">
        <button id="load-close" class="close btn-warn">Cerrar</button>
        <h3>Agregar desde lote</h3>
        <div class="row">
          <div>
            <label>Selecciona lote</label>
            <select id="lot-select"></select>
            <small class="muted">Lee lotes desde el módulo Control de Lotes. Si no aparecen, crea lotes allá primero.</small>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btn-load-lot" class="btn-ok">Agregar a evento</button>
          </div>
        </div>

        <div class="card">
          <h4>Detalle del lote</h4>
          <div id="lot-detail"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-eventos" class="tab card" style="display:none">
    <h2>Eventos</h2>

    <div class="row">
      <div>
        <label>Filtrar por grupo</label>
        <select id="events-group-filter">
          <option value="">— Todos —</option>
        </select>
      </div>
      <div>
        <label>Buscar</label>
        <input id="events-search" placeholder="Buscar evento...">
      </div>
    </div>

    <div id="events-list"></div>

    <div class="info">
      <small>
        <b>Cierre Total</b>: suma todos los días de un evento maestro (grupo) y genera un reporte consolidado.
        <br>
        <b>Cerrar evento</b> (en Vender): cierra solo el día actual.
      </small>
    </div>

    <div class="row">
      <button id="btn-cierre-total" class="btn-primary">Cierre Total (por grupo)</button>
      <button id="btn-export-events" class="btn-primary">Exportar eventos (Excel)</button>
    </div>

    <div id="cierre-total-modal" class="modal">
      <div class="panel">
        <button id="ct-close" class="close btn-warn">Cerrar</button>
        <h3>Cierre Total (Evento maestro)</h3>

        <div class="row">
          <div>
            <label>Grupo</label>
            <select id="ct-group"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btn-ct-generate" class="btn-ok">Generar cierre</button>
          </div>
        </div>

        <div class="card">
          <h4>Resumen</h4>
          <div id="ct-summary"></div>
        </div>

        <div class="row">
          <button id="btn-ct-export" class="btn-primary">Exportar (Excel)</button>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-caja" class="tab card" style="display:none">
    <h2>Caja Chica</h2>

    <div class="row">
      <div>
        <label>Evento</label>
        <select id="pc-event">
          <option value="">— Selecciona evento —</option>
        </select>
        <small class="muted">Caja Chica es por evento.</small>
      </div>
      <div>
        <label>Fecha</label>
        <input id="pc-date" type="date">
      </div>
    </div>

    <div class="card">
      <h3>Saldo inicial (detalle)</h3>
      <div id="pc-opening-detail"></div>
      <div class="row">
        <button id="btn-pc-set-opening" class="btn-primary">Definir saldo inicial</button>
      </div>
    </div>

    <div class="card">
      <h3>Movimientos</h3>
      <div class="row">
        <select id="pc-move-type">
          <option value="in">Ingreso</option>
          <option value="out">Egreso</option>
        </select>
        <input id="pc-move-amount" type="number" inputmode="decimal" step="0.01" placeholder="Monto">
      </div>
      <input id="pc-move-note" placeholder="Descripción (opcional)">
      <div class="row">
        <button id="btn-pc-add-move" class="btn-ok">Agregar movimiento</button>
      </div>
      <div id="pc-moves-list"></div>
    </div>

    <div class="card">
      <h3>Ventas en efectivo (del día)</h3>
      <div id="pc-cash-sales"></div>
      <small class="muted">Se calculan automáticamente desde el POS.</small>
    </div>

    <div class="card">
      <h3>Cierre del día</h3>
      <div id="pc-closing-detail"></div>
      <div class="row">
        <button id="btn-pc-close-day" class="btn-primary">Cerrar día (Caja Chica)</button>
      </div>
      <small class="muted">Cierre = saldo inicial + movimientos + ventas en efectivo del día.</small>
    </div>

    <div id="pc-opening-modal" class="modal">
      <div class="panel">
        <button id="pc-open-close" class="close btn-warn">Cerrar</button>
        <h3>Definir saldo inicial (detalle)</h3>
        <div id="pc-opening-form"></div>
        <div class="row">
          <button id="btn-pc-open-save" class="btn-ok">Guardar</button>
        </div>
      </div>
    </div>

    <div id="pc-closing-modal" class="modal">
      <div class="panel">
        <button id="pc-close-close" class="close btn-warn">Cerrar</button>
        <h3>Cerrar día (detalle)</h3>
        <div id="pc-closing-form"></div>
        <div class="row">
          <button id="btn-pc-close-save" class="btn-ok">Guardar cierre</button>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-resumen" class="tab card" style="display:none">
    <h2>Resumen</h2>

    <div class="grid">
      <div class="card">
        <h3>Ventas del día</h3>
        <div id="sum-day"></div>
        <small class="muted">Incluye cortesías y devoluciones.</small>
      </div>
      <div class="card">
        <h3>Evento activo</h3>
        <div id="sum-event"></div>
        <small class="muted">Muestra totales del evento seleccionado en Vender.</small>
      </div>
    </div>

    <div class="card">
      <h3>Por producto (día)</h3>
      <table id="sum-byprod">
        <thead><tr><th>Producto</th><th>Cant</th><th>Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row">
      <button id="btn-export-summary" class="btn-primary">Exportar resumen (Excel)</button>
    </div>
  </section>

  <section id="tab-productos" class="tab card" style="display:none">
    <h2>Productos</h2>
    <div id="productos-list"></div>
    <div class="row">
      <input id="new-name" placeholder="Nombre">
      <input id="new-price" type="number" inputmode="decimal" step="0.01" placeholder="Precio">
    </div>
    <div class="row">
      <button id="btn-add-prod" class="btn-ok">+ Agregar producto</button>
      <button id="btn-restore-seed" class="btn-warn">Restaurar productos base (A33)</button>
    </div>
    <div class="info"><small>Si por cualquier razón solo ves “Vaso”, usa el botón <b>Restaurar productos base (A33)</b>. No borra ventas.</small></div>

    <!-- ✨ Nuevo ítem (Extras / Otros productos) -->
    <div class="card" id="extras-card">
      <div class="row" style="align-items:center">
        <div>
          <h3 style="margin:0">Otros productos <span class="badge">✨</span></h3>
          <small class="muted">Ítems ad-hoc para vender sin crearlos en Inventario central/Lotes. Viven solo en el POS (por evento + “Extras guardados”).</small>
        </div>
        <div style="text-align:right">
          <button id="btn-extra-new" class="btn-primary" type="button">✨ Nuevo ítem</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Evento (extras)</label>
          <select id="extras-event">
            <option value="">— Selecciona evento —</option>
          </select>
          <small class="muted">Gestiona los extras del evento aquí. (No afecta el evento activo de venta.)</small>
        </div>
        <div>
          <label>Extras guardados</label>
          <select id="extras-templates-select">
            <option value="">— Selecciona para usar —</option>
          </select>
          <small class="muted">Al seleccionar un template, se abre el editor prellenado (opción B).</small>
        </div>
      </div>

      <div class="grid extras-grid">
        <div class="card">
          <h4>En este evento</h4>
          <div id="extras-event-list" class="extras-list"></div>
        </div>
        <div class="card">
          <h4>Extras guardados</h4>
          <div id="extras-templates-list" class="extras-list"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Bancos</h3>
      <div id="banks-list"></div>
      <div class="row">
        <input id="bank-new-name" placeholder="Nombre del banco">
        <button id="btn-add-bank" class="btn-ok">+ Agregar banco</button>
      </div>
      <div class="info"><small>Consejo: mejor <b>desactivar</b> bancos en lugar de borrarlos, para que el historial no quede huérfano.</small></div>
    </div>
  </section>

  <section id="tab-ayuda" class="tab card" style="display:none">
    <h2>Ayuda</h2>
    <ul>
      <li>Los <b>botones de producto</b> muestran <b>todos los Activos</b>. Tocar = seleccionar. Tocar de nuevo = +1 cantidad (venta rápida).</li>
      <li>Al cerrar un evento: la app queda en blanco sin evento activo. El evento cerrado conserva su info y puedes verla con <b>VER</b> en la pestaña Eventos.</li>
    </ul>
  </section>

</div>

<!-- Modal VER evento -->
<div id="event-view" class="modal">
  <div class="panel">
    <button id="ev-close" class="close btn-warn">Cerrar</button>
    <h3 id="ev-title">Evento</h3>
    <div class="grid">
      <div class="card" id="ev-meta"></div>
      <div class="card" id="ev-totals"></div>
    </div>
    <div class="grid">
      <div class="card">
        <h4>Por día</h4>
        <table id="ev-byday"><thead><tr><th>Fecha</th><th>Total</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h4>Por producto</h4>
        <table id="ev-byprod"><thead><tr><th>Producto</th><th>Total</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="card">
      <h4>Ventas</h4>
      <div class="scroll">
        <table id="ev-sales">
          <thead><tr><th>ID</th><th>Fecha</th><th>Hora</th><th>Producto</th><th>Cant</th><th>PU</th><th>Desc</th><th>Total</th><th>Pago</th><th>C</th><th>Dev</th><th>Cliente</th><th>Cortesía a</th><th>Notas</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: ✨ Nuevo ítem / Extras -->
<div id="extra-modal" class="modal">
  <div class="panel">
    <button id="extra-close" class="close btn-warn" type="button">Cerrar</button>
    <h3 id="extra-modal-title">✨ Nuevo ítem</h3>

    <input type="hidden" id="extra-state-mode" value="">
    <input type="hidden" id="extra-state-eventId" value="">
    <input type="hidden" id="extra-state-extraId" value="">
    <input type="hidden" id="extra-state-templateId" value="">

    <div class="row">
      <div>
        <label>Nombre</label>
        <input id="extra-name" placeholder="ej. Escudilla charcutería">
      </div>
      <div>
        <label>Precio (C$)</label>
        <input id="extra-price" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
      </div>
      <div>
        <label>Costo (C$)</label>
        <input id="extra-cost" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
      </div>
    </div>

    <div class="row" style="grid-template-columns:1fr 1fr; align-items:center">
      <div>
        <label class="flag"><input id="extra-active" type="checkbox" checked> Activo</label>
        <label class="flag"><input id="extra-manage-stock" type="checkbox"> Controlar stock en este evento</label>
      </div>

      <div id="extra-stock-block" style="display:none">
        <label>Stock actual</label>
        <div class="row" style="grid-template-columns:1fr auto; gap:8px">
          <input id="extra-stock" type="number" inputmode="numeric" step="1" min="0" value="0">
          <button id="extra-restock" type="button" class="btn-ok">Agregar más stock</button>
        </div>
        <small class="muted">En 0 se bloquean ventas y cortesías. Alerta cuando queden 5.</small>
      </div>
    </div>

    <div class="row" style="grid-template-columns:1fr 1fr; align-items:center">
      <div>
        <label class="flag"><input id="extra-save-template" type="checkbox"> Guardar/actualizar en “Extras guardados”</label>
        <small class="muted">Guarda como template para reutilizar en otros eventos.</small>
      </div>
      <div style="text-align:right">
        <button id="extra-delete" type="button" class="btn-danger">Eliminar</button>
      </div>
    </div>

    <div class="row">
      <button id="extra-save" type="button" class="btn-ok">Guardar</button>
      <button id="extra-cancel" type="button" class="btn-warn">Cancelar</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Hecho</div>
<footer></footer>
<nav class="tabbar">
  <button data-tab="venta" class="active">Vender</button>
  <button data-tab="inventario">Inventario</button>
  <button data-tab="eventos">Eventos</button>
  <button data-tab="caja">Caja Chica</button>
  <button data-tab="resumen">Resumen</button>
  <button data-tab="productos">Productos</button>
  <button data-tab="ayuda">Ayuda</button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="app.js?v=3.20"></script>
<script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js?v=3.20'); }
</script>
</body>
</html>
